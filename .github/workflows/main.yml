name: main

on:
  workflow_dispatch:
  
permissions:
  contents: read
  issues: write

jobs:
  main:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3
      - name: Setup Ansible
        run: sudo apt-get install -y ansible
      - name: Check VARS secret exists
        env:
          VARS_JSON: ${{ secrets.VARS_JSON }}
        run: |
          if [ -z "$VARS_JSON" ]; then
            echo "Error: Secret VARS is missing or empty"
            exit 1
          fi
      - name: Export VARS env as outputs
        id: export_vars
        env:
          VARS_JSON: ${{ secrets.VARS_JSON }}
        run: |
          echo "$VARS_JSON" | jq -r 'to_entries[] | "\(.key)=\(.value)"' \
            | while IFS= read -r line; do
                echo "$line" >> $GITHUB_OUTPUT
                echo "Output ${line%%=*}"
              done
      - name: Create vars.json from secret
        run: |
          echo '${{ secrets.VARS_JSON }}' > vars.json
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.SERVICE_ACCOUNT }} 
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{steps.export_vars.outputs.gcloud_project_id}}
      - name: Creates / Checks state bucket (GCS)
        env:
          BUCKET_NAME: ${{ steps.export_vars.outputs.project_name }}-bucket-state
          GCP_PROJECT: ${{ steps.export_vars.outputs.gcloud_project_id }}
        run: |
          # 1. Check if bucket exists
          if gsutil ls -p "$GCP_PROJECT" "gs://$BUCKET_NAME" >/dev/null 2>&1; then
            echo "Bucket already exists: $BUCKET_NAME"
          else
            echo "Bucket does not exist. Creating: $BUCKET_NAME"

            # 2. Create bucket
            gsutil mb -p "$GCP_PROJECT" "gs://$BUCKET_NAME"

            # 3. Block all public access
            gcloud storage buckets update gs://$BUCKET_NAME --uniform-bucket-level-access

            # 5. Enable versioning
            echo "Enabling versioning"
            gsutil versioning set on "gs://$BUCKET_NAME"

            # 6. Enable default encryption with Google-managed key
            echo "Enabling default encryption (Google-managed key)"
            gsutil encryption -d "gs://$BUCKET_NAME"
          fi